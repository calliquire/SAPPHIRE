---
title: "data_modeling_1"
author: "calliquire"
date: "2024-10-03"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

**About This Analysis:** The goal of this analysis is to fit a Linear Mixed Effects Model to the cleaned and filtered data set.

**Purpose of the Model:** The linear mixed-effects model aims to predict the reflectance values while accounting for both fixed effects (collection periods and reflectance metrics) and random effects (individual differences among participants). This is especially useful in repeated measures data, where you want to understand how specific factors influence the response while considering individual variability.

*Fixed Effects Interpretation:* The fixed effects coefficients will tell you:

-   How much the reflectance value changes with different collection periods, holding the reflectance metric constant.

-   How much the reflectance value changes with different reflectance metrics, holding the collection period constant. - How the relationship between reflectance values and collection period varies for different metrics.

*Random Effects Interpretation:* The random effects component allows you to model the inherent variability between participants. For example, if one participant consistently has higher reflectance values than another, the model accounts for that difference.

## Set Up

1.  Load the data.

```{r}
data <- read.csv("data/screening_data/filtered_screening_long.csv")
```

2.  Load relevant libraries.

```{r, message=FALSE, warning=FALSE}
library(ggstatsplot)
library(ggplot2)
library(ggeffects)
library(dplyr)
library(viridis)
library(lme4)
```

## Linear Mixed Effects Modeling

3.  Convert the categorical columns into factors.

```{r}
data$collection_period <- factor(data$collection_period, levels = c("Summer", "Winter", "6Weeks"))
data$reflectance_metric <- as.factor(data$reflectance_metric)
```

4.  Fit the Linear Mixed Effects Model.

An overview of this model:

*Response Variable:*

-   reflectance_value: This is the dependent variable (response) that you are trying to predict or explain. It represents the measured reflectance values from the different metrics across various collection periods.

*Fixed Effects:*

-   collection_period: This is a categorical independent variable that denotes different time periods when the measurements were taken (e.g., Summer, Winter, and 6 Weeks). It helps in examining how reflectance values vary across these periods.

-   reflectance_metric: This is another categorical independent variable representing different types of reflectance metrics (e.g., e1, e2, m1, etc.). It helps assess how the type of metric influences reflectance values.

-   collection_period \* reflectance_metric: The asterisk (\*) indicates that you are including both main effects (collection period and reflectance metric) and their interaction. This allows you to see not only the individual effects of each variable but also how the effect of one variable depends on the level of the other (e.g., how the relationship between reflectance values and collection period changes across different metrics).

*Random Effects:*

-   (1 \| participant_centre_id): This part of the model specifies a random intercept for participants. Here, participant_centre_id is the grouping variable representing individual participants (or centres, depending on the context). By including this random effect:

    -   You allow for individual differences in the baseline level of reflectance values. Each participant can have their own average reflectance value, accounting for natural variability between participants.

    -   The model captures correlations in reflectance values within the same participant, given that repeated measurements are taken on each individual.

```{r}
model <- lmer(reflectance_value ~ collection_period * reflectance_metric + (1 | participant_centre_id), data = data)

# Summarize the model
summary(model)
```

5.  Generate predicted values using ggpredict.

```{r}
predicted_values <- ggpredict(model, terms = c("collection_period", "reflectance_metric"))

# Ensure all levels of collection_period are included in the predictions
predicted_values$x <- factor(predicted_values$x, levels = c("Summer", "Winter", "6Weeks"))
```

5.  Visualize the predicted values of the model. Define a custom color palette that corresponds to the meaning of each reflectance metric.

```{r, fig.width=11, fig.height=8}
# Define the custom color palette
color_palette <- c(
  "e1" = "#FF9AAB",   # Light Pink 
  "e2" = "#FF6F91",   # Pink
  "e3" = "#D9385A",   # Deep Pink
  "m1" = "#FFD5A1",   # Light Tan
  "m2" = "#C89A5B",   # Tan
  "m3" = "#7D4F26",   # Dark Brown
  "r1" = "#FFA07A",   # Light Orange
  "r2" = "#FF8C00",   # Medium Orange
  "r3" = "#FF4500",   # Dark Orange
  "g1" = "#B2FFB2",   # Light Green
  "g2" = "#6BFF6B",   # Green
  "g3" = "#2B5D2B",   # Dark Green
  "b1" = "#A7C6E7",   # Light Blue
  "b2" = "#3A8EDB",   # Blue
  "b3" = "#1A3F78",   # Dark Blue
  "l_1" = "#D3D3D3",   # Light Grey
  "l_2" = "#A9A9A9",   # Grey
  "l_3" = "#7B7B7B",   # Dark Grey
  "a_1" = "#FFEB91",   # Light Yellow
  "a_2" = "#FFD300",   # Yellow
  "a_3" = "#A57B00",   # Goldenrod
  "b_1" = "#E0BBFF",   # Lavender
  "b_2" = "#A35CC3",   # Purple
  "b_3" = "#5E1B94"    # Dark Violet
)

p1 <- ggplot(predicted_values, aes(x = x, y = predicted, group = group, color = group)) + 
  geom_line(size = 1) + 
  geom_point(size = 2) +
  labs(title = "Predicted Reflectance Value by Collection Period and Reflectance Metric",
       x = "Collection Period",
       y = "Predicted Reflectance Value") +
  scale_color_manual(values = color_palette, name = "Reflectance Metric") + 
  theme_minimal()

# Print the resulting plot
print(p1)
```

6.  Save the plot as a .pdf.

```{r}
ggsave("output/predicted_reflectance_values.pdf", plot = p1, width = 11, height = 8, device = "pdf")
```

7. Visualize the same model but faceted by reflectance metric.
```{r, fig.width=14, fig.height=10}
p2 <- ggplot(predicted_values, aes(x = x, y = predicted, group = group, color = group)) + 
  geom_line(size = .75) +  # Keep the lines
  geom_point(size = 1) + # Keep the points
  labs(title = "Predicted Reflectance Value by Collection Period and Reflectance Metric",
       x = "Collection Period",
       y = "Predicted Reflectance Value") +
  scale_color_manual(values = color_palette) +
  theme_minimal() +
  facet_wrap(~ group, ncol = 3) +
  theme(
    panel.spacing = unit(1, "lines"),  # Increase spacing between panels
    strip.text = element_text(size = 10),  # Adjust facet label size
    axis.text = element_text(size = 8),  # Adjust axis text size
    axis.title = element_text(size = 10),  # Adjust axis title size
    legend.position = "none"  # Remove the legend
  )

# Print the resulting plot
print(p2)
```

8. Save the faceted plot as a .pdf.
```{r}
ggsave("output/predicted_reflectance_faceted.pdf", plot = p2, width = 11, height = 8, device = "pdf")
```

